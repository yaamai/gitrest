<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
</head>
<body>

<script src="codemirror-5.59.4/lib/codemirror.js"></script>
<link rel="stylesheet" href="codemirror-5.59.4/lib/codemirror.css">
<script src="codemirror-5.59.4/mode/javascript/javascript.js"></script>
<script src="codemirror-5.59.4/keymap/vim.js"></script>

<script>

var notify_id = "";
var myCodeMirror = CodeMirror(document.body, {
  value: "",
  mode:  "javascript",
  keyMap: "vim"
});

myCodeMirror.on("change", (cm, change) => {
    console.log("c:", change);
})
myCodeMirror.on("changes", (cm, change) => {
    console.log("changes:", change, cm);
    console.log("changes:", cm);
    if (change.length > 0 && change[0].origin == "setValue") { return; }
    var oReq = new XMLHttpRequest();
    oReq.open("POST", "/test");
    oReq.setRequestHeader("X-Notify-Id", notify_id);
    oReq.send(cm.getValue());
    oReq.addEventListener("loadend", (e) => {
        current_commit = oReq.getResponseHeader("X-Commit");
    })
})

var r = new XMLHttpRequest();
r.open("GET", "/test");
r.addEventListener("loadend", (e) => {
    myCodeMirror.setValue(r.responseText);
    current_commit = r.getResponseHeader("X-Commit");
})
r.send();

var socket = new WebSocket("ws://" + window.location.host + "/notifies/test");
socket.onmessage = function(e) {
    console.log(e.data);

    const data = JSON.parse(e.data)
    if(data.type == "id") { notify_id = data.id; return; };

    var r = new XMLHttpRequest();
    r.open("GET", "/test");
    r.addEventListener("loadend", (e) => {
        myCodeMirror.setValue(r.responseText);
    })
    r.send();
};


</script>

</body>
</html>